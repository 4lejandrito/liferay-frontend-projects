{"version":3,"sources":["HtmlScreen.js"],"names":["HtmlScreen","titleSelector","releaseVirtualDocument","pendingStyles","htmlString","virtualDocument","document","createElement","copyNodeAttributesFromContent_","innerHTML","newStyle","isTemporaryStyle","selectors","stylesTemporary","push","id","styleInDoc","getElementById","parentNode","insertBefore","nextSibling","head","appendChild","bodySurface","querySelector","body","content","node","replace","placeholder","isIe","tempNode","createRange","createContextualFragment","clearNodeAttributes","copyNodeAttributes","disposePendingStyles","removeElementsFromDocument","surfaces","evaluateTrackedScripts","evaluateTrackedResources_","runScriptsInElement","scripts","scriptsTemporary","scriptsPermanent","then","evaluateTrackedStyles","runStylesInElement","styles","stylesPermanent","appendStyleIntoDocument_","bind","resourcesInVirtual","virtualQuerySelectorAll_","favicon","resourcesInDocument","querySelectorAll_","resolve","runFaviconInElement_","evaluatorFn","selector","selectorTemporary","selectorPermanent","opt_appendResourceFn","tracked","temporariesInDoc","permanentsInDoc","forEach","resource","resourceKey","getResourceKey_","permanentResourcesInDoc","frag","documentElement","evaluateFavicon_","href","src","surfaceId","surface","defaultChild","DEFAULT","path","allocateVirtualDocumentForContent","resolveTitleFromVirtualDocument","assertSameBodyIdInVirtualDocument","makeTemporaryStylesHrefsUnique_","style","replaceStyleAndMakeUnique_","tagName","makeUnique","toString","replaceChild","disabled","elements","element","setElementWithRandomHref","Array","prototype","slice","call","querySelectorAll","title","setTitle","textContent","trim","ignoreFavicon"],"mappings":"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","file":"src/screen/HtmlScreen.js","sourcesContent":["'use strict';\n\nimport { getUid } from 'metal';\nimport { buildFragment, globalEval, globalEvalStyles, match } from 'metal-dom';\nimport CancellablePromise from 'metal-promise';\nimport globals from '../globals/globals';\nimport RequestScreen from './RequestScreen';\nimport Surface from '../surface/Surface';\nimport UA from 'metal-useragent';\nimport Uri from 'metal-uri';\nimport utils from '../utils/utils';\n\nclass HtmlScreen extends RequestScreen {\n\n\t/**\n\t * Screen class that perform a request and extracts surface contents from\n\t * the response content.\n\t * @constructor\n\t * @extends {RequestScreen}\n\t */\n\tconstructor() {\n\t\tsuper();\n\n\t\t/**\n\t\t * Holds the title selector. Relevant to extract the <code><title></code>\n\t\t * element from request fragments to use as the screen title.\n\t\t * @type {!string}\n\t\t * @default title\n\t\t * @protected\n\t\t */\n\t\tthis.titleSelector = 'title';\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tactivate() {\n\t\tsuper.activate();\n\t\tthis.releaseVirtualDocument();\n\t\tthis.pendingStyles = null;\n\t}\n\n\t/**\n\t * Allocates virtual document for content. After allocated virtual document\n\t * can be accessed by <code>this.virtualDocument</code>.\n\t * @param {!string} htmlString\n\t */\n\tallocateVirtualDocumentForContent(htmlString) {\n\t\tif (!this.virtualDocument) {\n\t\t\tthis.virtualDocument = globals.document.createElement('html');\n\t\t}\n\n\t\tthis.copyNodeAttributesFromContent_(htmlString, this.virtualDocument);\n\n\t\tthis.virtualDocument.innerHTML = htmlString;\n\t}\n\n\t/**\n\t * Customizes logic to append styles into document. Relevant to when\n\t * tracking a style by id make sure to re-positions the new style in the\n\t * same dom order.\n\t * @param {Element} newStyle\n\t */\n\tappendStyleIntoDocument_(newStyle) {\n\t\tvar isTemporaryStyle = match(newStyle, HtmlScreen.selectors.stylesTemporary);\n\t\tif (isTemporaryStyle) {\n\t\t\tthis.pendingStyles.push(newStyle);\n\t\t}\n\t\tif (newStyle.id) {\n\t\t\tvar styleInDoc = globals.document.getElementById(newStyle.id);\n\t\t\tif (styleInDoc) {\n\t\t\t\tstyleInDoc.parentNode.insertBefore(newStyle, styleInDoc.nextSibling);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tglobals.document.head.appendChild(newStyle);\n\t}\n\n\t/**\n\t * If body is used as surface forces the requested documents to have same id\n\t * of the initial page.\n\t */\n\tassertSameBodyIdInVirtualDocument() {\n\t\tvar bodySurface = this.virtualDocument.querySelector('body');\n\t\tif (!globals.document.body.id) {\n\t\t\tglobals.document.body.id = 'senna_surface_' + getUid();\n\t\t}\n\t\tif (bodySurface) {\n\t\t\tbodySurface.id = globals.document.body.id;\n\t\t}\n\t}\n\n\t/**\n\t * Copies attributes from the <html> tag of content to the given node.\n\t */\n\tcopyNodeAttributesFromContent_(content, node) {\n\t\tcontent = content.replace(/[<]\\s*html/ig, '<senna');\n\t\tcontent = content.replace(/\\/html\\s*\\>/ig, '/senna>');\n\t\tlet placeholder;\n\t\tif (UA.isIe) {\n\t\t\tconst tempNode = globals.document.createRange().createContextualFragment(content);\n\t\t\tplaceholder = tempNode.querySelector('senna');\n\t\t} else {\n\t\t\tnode.innerHTML = content;\n\t\t\tplaceholder = node.querySelector('senna');\n\t\t}\n\n\t\tif (placeholder) {\n\t\t\tutils.clearNodeAttributes(node);\n\t\t\tutils.copyNodeAttributes(placeholder, node);\n\t\t}\n\t}\n\n\t/**\n\t * @Override\n\t */\n\tdisposeInternal() {\n\t\tthis.disposePendingStyles();\n\t\tsuper.disposeInternal();\n\t}\n\n\t/**\n\t * Disposes pending styles if screen get disposed prior to its loading.\n\t */\n\tdisposePendingStyles() {\n\t\tif (this.pendingStyles) {\n\t\t\tutils.removeElementsFromDocument(this.pendingStyles);\n\t\t}\n\t}\n\n\t/**\n\t * @Override\n\t */\n\tevaluateScripts(surfaces) {\n\t\tvar evaluateTrackedScripts = this.evaluateTrackedResources_(\n\t\t\tglobalEval.runScriptsInElement, HtmlScreen.selectors.scripts,\n\t\t\tHtmlScreen.selectors.scriptsTemporary, HtmlScreen.selectors.scriptsPermanent);\n\n\t\treturn evaluateTrackedScripts.then(() => super.evaluateScripts(surfaces));\n\t}\n\n\t/**\n\t * @Override\n\t */\n\tevaluateStyles(surfaces) {\n\t\tthis.pendingStyles = [];\n\t\tvar evaluateTrackedStyles = this.evaluateTrackedResources_(\n\t\t\tglobalEvalStyles.runStylesInElement, HtmlScreen.selectors.styles,\n\t\t\tHtmlScreen.selectors.stylesTemporary, HtmlScreen.selectors.stylesPermanent,\n\t\t\tthis.appendStyleIntoDocument_.bind(this));\n\n\t\treturn evaluateTrackedStyles.then(() => super.evaluateStyles(surfaces));\n\t}\n\n\t/**\n\t * Allows a screen to evaluate the favicon style before the screen becomes visible.\n\t * @return {CancellablePromise}\n\t */\n\tevaluateFavicon_() {\n\t\tconst resourcesInVirtual = this.virtualQuerySelectorAll_(HtmlScreen.selectors.favicon);\n\t\tconst resourcesInDocument = this.querySelectorAll_(HtmlScreen.selectors.favicon);\n\n\t\treturn new CancellablePromise((resolve) => {\n\t\t\tutils.removeElementsFromDocument(resourcesInDocument);\n\t\t\tthis.runFaviconInElement_(resourcesInVirtual).then(() => resolve());\n\t\t});\n\t}\n\n\t/**\n\t * Evaluates tracked resources inside incoming fragment and remove existing\n\t * temporary resources.\n\t * @param {?function()} appendFn Function to append the node into document.\n\t * @param {!string} selector Selector used to find resources to track.\n\t * @param {!string} selectorTemporary Selector used to find temporary\n\t *     resources to track.\n\t * @param {!string} selectorPermanent Selector used to find permanent\n\t *     resources to track.\n\t * @param {!function} opt_appendResourceFn Optional function used to\n\t *     evaluate fragment containing resources.\n\t * @return {CancellablePromise} Deferred that waits resources evaluation to\n\t *     complete.\n\t * @private\n\t */\n\tevaluateTrackedResources_(evaluatorFn, selector, selectorTemporary, selectorPermanent, opt_appendResourceFn) {\n\t\tvar tracked = this.virtualQuerySelectorAll_(selector);\n\t\tvar temporariesInDoc = this.querySelectorAll_(selectorTemporary);\n\t\tvar permanentsInDoc = this.querySelectorAll_(selectorPermanent);\n\n\t\t// Adds permanent resources in document to cache.\n\t\tpermanentsInDoc.forEach((resource) => {\n\t\t\tvar resourceKey = this.getResourceKey_(resource);\n\t\t\tif (resourceKey) {\n\t\t\t\tHtmlScreen.permanentResourcesInDoc[resourceKey] = true;\n\t\t\t}\n\t\t});\n\n\t\tvar frag = buildFragment();\n\t\ttracked.forEach((resource) => {\n\t\t\tvar resourceKey = this.getResourceKey_(resource);\n\t\t\t// Do not load permanent resources if already in document.\n\t\t\tif (!HtmlScreen.permanentResourcesInDoc[resourceKey]) {\n\t\t\t\tfrag.appendChild(resource);\n\t\t\t}\n\t\t\t// If resource has key and is permanent add to cache.\n\t\t\tif (resourceKey && match(resource, selectorPermanent)) {\n\t\t\t\tHtmlScreen.permanentResourcesInDoc[resourceKey] = true;\n\t\t\t}\n\t\t});\n\n\t\treturn new CancellablePromise((resolve) => {\n\t\t\tevaluatorFn(frag, () => {\n\t\t\t\tutils.removeElementsFromDocument(temporariesInDoc);\n\t\t\t\tresolve();\n\t\t\t}, opt_appendResourceFn);\n\t\t});\n\t}\n\n\t/**\n\t * @Override\n\t */\n\tflip(surfaces) {\n\t\treturn super.flip(surfaces).then(() => {\n\t\t\tutils.clearNodeAttributes(globals.document.documentElement);\n\t\t\tutils.copyNodeAttributes(this.virtualDocument, globals.document.documentElement);\n\t\t\tthis.evaluateFavicon_();\n\t\t});\n\t}\n\n\t/**\n\t * Extracts a key to identify the resource based on its attributes.\n\t * @param {Element} resource\n\t * @return {string} Extracted key based on resource attributes in order of\n\t *     preference: id, href, src.\n\t */\n\tgetResourceKey_(resource) {\n\t\treturn resource.id || resource.href || resource.src || '';\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tgetSurfaceContent(surfaceId) {\n\t\tvar surface = this.virtualDocument.querySelector('#' + surfaceId);\n\t\tif (surface) {\n\t\t\tvar defaultChild = surface.querySelector('#' + surfaceId + '-' + Surface.DEFAULT);\n\t\t\tif (defaultChild) {\n\t\t\t\treturn defaultChild.innerHTML;\n\t\t\t}\n\t\t\treturn surface.innerHTML; // If default content not found, use surface content\n\t\t}\n\t}\n\n\t/**\n\t * Gets the title selector.\n\t * @return {!string}\n\t */\n\tgetTitleSelector() {\n\t\treturn this.titleSelector;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tload(path) {\n\t\treturn super.load(path)\n\t\t\t.then(content => {\n\t\t\t\tthis.allocateVirtualDocumentForContent(content);\n\t\t\t\tthis.resolveTitleFromVirtualDocument();\n\t\t\t\tthis.assertSameBodyIdInVirtualDocument();\n\t\t\t\tif (UA.isIe) {\n\t\t\t\t\tthis.makeTemporaryStylesHrefsUnique_();\n\t\t\t\t}\n\t\t\t\treturn content;\n\t\t\t});\n\t}\n\n\t/**\n\t * Queries temporary styles from virtual document, and makes them unique.\n\t * This is necessary for caching and load event firing issues specific to\n\t * IE11. https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/7940171/\n\t */\n\tmakeTemporaryStylesHrefsUnique_() {\n\t\tvar temporariesInDoc = this.virtualQuerySelectorAll_(HtmlScreen.selectors.stylesTemporary);\n\t\ttemporariesInDoc.forEach((style) => this.replaceStyleAndMakeUnique_(style));\n\t}\n\n\t/**\n\t * Creates a new element from given, copies attributes, mutates href to be\n\t * unique to prevent caching and more than one load/error event from firing.\n\t */\n\treplaceStyleAndMakeUnique_(style) {\n\t\tif (style.href) {\n\t\t\tvar newStyle = globals.document.createElement(style.tagName);\n\t\t\tstyle.href = new Uri(style.href).makeUnique().toString();\n\t\t\tutils.copyNodeAttributes(style, newStyle);\n\t\t\tstyle.parentNode.replaceChild(newStyle, style);\n\t\t\tstyle.disabled = true;\n\t\t}\n\t}\n\n\t/**\n\t * Adds the favicon elements to the document.\n\t * @param {!Array<Element>} elements\n\t * @private\n\t * @return {CancellablePromise}\n\t */\n\trunFaviconInElement_(elements) {\n\t\treturn new CancellablePromise((resolve) => {\n\t\t\telements.forEach((element) => document.head.appendChild(\n\t\t\t\tutils.setElementWithRandomHref(element)\n\t\t\t));\n\t\t\tresolve();\n\t\t});\n\t}\n\n\t/**\n\t * Queries elements from virtual document and returns an array of elements.\n\t * @param {!string} selector\n\t * @return {array.<Element>}\n\t */\n\tvirtualQuerySelectorAll_(selector) {\n\t\treturn Array.prototype.slice.call(this.virtualDocument.querySelectorAll(selector));\n\t}\n\n\t/**\n\t * Queries elements from document and returns an array of elements.\n\t * @param {!string} selector\n\t * @return {array.<Element>}\n\t */\n\tquerySelectorAll_(selector) {\n\t\treturn Array.prototype.slice.call(globals.document.querySelectorAll(selector));\n\t}\n\n\t/**\n\t * Releases virtual document allocated for content.\n\t */\n\treleaseVirtualDocument() {\n\t\tthis.virtualDocument = null;\n\t}\n\n\t/**\n\t * Resolves title from allocated virtual document.\n\t */\n\tresolveTitleFromVirtualDocument() {\n\t\tvar title = this.virtualDocument.querySelector(this.titleSelector);\n\t\tif (title) {\n\t\t\tthis.setTitle(title.textContent.trim());\n\t\t}\n\t}\n\n\t/**\n\t * Sets the title selector.\n\t * @param {!string} titleSelector\n\t */\n\tsetTitleSelector(titleSelector) {\n\t\tthis.titleSelector = titleSelector;\n\t}\n\n}\n\n/**\n * Helper selector for ignore favicon when exist data-senna-track.\n */\nconst ignoreFavicon = ':not([rel=\"Shortcut Icon\"]):not([rel=\"shortcut icon\"]):not([rel=\"icon\"]):not([href$=\"favicon.icon\"])';\n\n/**\n * Helper selectors for tracking resources.\n * @type {object}\n * @protected\n * @static\n */\nHtmlScreen.selectors = {\n\tfavicon: 'link[rel=\"Shortcut Icon\"],link[rel=\"shortcut icon\"],link[rel=\"icon\"],link[href$=\"favicon.icon\"]',\n\tscripts: 'script[data-senna-track]',\n\tscriptsPermanent: 'script[data-senna-track=\"permanent\"]',\n\tscriptsTemporary: 'script[data-senna-track=\"temporary\"]',\n\tstyles: `style[data-senna-track],link[data-senna-track]${ignoreFavicon}`,\n\tstylesPermanent: `style[data-senna-track=\"permanent\"],link[data-senna-track=\"permanent\"]${ignoreFavicon}`,\n\tstylesTemporary: `style[data-senna-track=\"temporary\"],link[data-senna-track=\"temporary\"]${ignoreFavicon}`\n};\n\n/**\n * Caches permanent resource keys.\n * @type {object}\n * @protected\n * @static\n */\nHtmlScreen.permanentResourcesInDoc = {};\n\nexport default HtmlScreen;\n"],"sourceRoot":"/source/"}